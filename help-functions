#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

cmd-tailscale-help() {
  declare desc="help command"
  declare CMD="$1"
  local plugin_name="tailscale"
  local plugin_description="Run tailscale sidecar for an app or service"
  local plugin_description_long="$(cat <<desc
Run tailscale sidecar for an app or service

This plugin expects global configuration values set for the oauth key:

  dokku config:set --global TS_AUTHKEY=tskey-client-00000000000000000-000000000000000000000000000000000

For apps: If adding to an existing app, you will need to restart the app after running tailscale:up.
For services: Works with any Dokku service plugin (postgres, redis, mysql, etc.).

Examples:
  dokku tailscale:up myapp                    # Enable for app
  dokku tailscale:up --service postgres.db   # Enable for postgres service
  dokku tailscale:serve --service redis.cache 6379  # Serve redis over HTTPS
desc
)"

  if [[ "$CMD" == "${plugin_name}:help" ]]; then
    echo -e "Usage: dokku ${plugin_name}[:COMMAND]"
    echo ''
    echo "$plugin_description_long"
    echo ''
    echo 'Additional commands:'
    fn-help-content | sort | column -c2 -t -s,
  else
    cat <<help_desc
    $plugin_name, $plugin_description
help_desc
  fi
}

fn-help-content() {
  declare desc="return help content"
  cat <<help_content
    tailscale:up [--service] <app|service>, Starts the tailscale machine (use --service for services like postgres.mydb)
    tailscale:down [--service] <app|service>, Stops the tailscale sidecar
    tailscale:serve [--service] <app|service> [<port>|stop], Starts or stops serving the provided port over https
    tailscale:report [--service] <app|service>, Shows tailscale status information
    tailscale:logs [--service] <app|service> [-t|--tail] [<lines>], Follows tailscale sidecar logs (default follow). Optional lines limits initial output
help_content
}
